import tvar
import from _fiber (spawn, activate)

fun coroutine fn ->
    (fiber1, fiber2) = spawn ()

    first_call = tvar:create false

    fun _coroutine_handler ...args ->
        cond
        | (tvar:read first_call) `is` false ->
            tvar:swap first_call true
            activate fiber2,
                     lam () -> apply fn (concat (fiber1, ), args)
        | else ->
            apply fiber2 args
        ---
    ---
---

