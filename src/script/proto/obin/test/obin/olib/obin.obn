import tvar

func coroutine(fn) ->
    (fiber1, fiber2) = spawn_fiber()

    first_call = tvar.create(false)

    func(...args) ->
        state = tvar.read(first_call)
        if state is false
            tvar.swap(first_call, true)
            activate_fiber(fiber2,
                    func() ->
                        apply(fn, concat((fiber1, ), args)) end)
        else
            apply(fiber2, args)
        end
    end
end

nil
